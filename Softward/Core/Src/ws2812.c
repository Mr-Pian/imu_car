#include "ws2812.h"

Color_tpye color={0,0,0};//灯带rgb值储存处

long dif_l=0,dif_r=0;

//使用PWM+DMA驱动ws2812时要注意定时器是多少位的，如果是16位计数器则DMA为半字，如果是32位计数器则DMA为全字 
 
//显存数组，长度为 灯的数量*24+复位周期
uint32_t WS2812_RGB_Buff[LED_NUM*DATA_LEN+WS2812_RST_NUM] = {0}; 
 
/**
 * 函数：WS2812单灯设置函数
 * 参数：num:灯的位置，R、G、B分别为三个颜色通道的亮度，最大值为255
 * 作用：单独设置每一个WS2812的颜色
***/
void WS2812_Set(uint16_t num,uint8_t R,uint8_t Gr,uint8_t B)
{
  uint32_t indexx=(num*(3*8));
  for (uint8_t i = 0;i < 8;i++)
  {
	//填充数组
	WS2812_RGB_Buff[indexx+i]      = (Gr << i) & (0x80)?WS_H:WS_L;
	WS2812_RGB_Buff[indexx+i + 8]  = (R << i) & (0x80)?WS_H:WS_L;
	WS2812_RGB_Buff[indexx+i + 16] = (B << i) & (0x80)?WS_H:WS_L;
  }
}
 
//WS2812初始化函数
void WS2812_Init()
{
	//设置关闭所有灯
  for(int i=0;i<LED_NUM;i++)
  {
			WS2812_Set(i,0,0,0);
  }
  //作用：调用DMA将显存中的内容实时搬运至定时器的比较寄存器
  HAL_TIM_PWM_Start_DMA(&htim2,TIM_CHANNEL_4,(uint32_t *)WS2812_RGB_Buff,sizeof(WS2812_RGB_Buff)/sizeof(uint32_t)); 
	
}

/************************************************************************************************************
** WS2812_Set_Color(uint8_t R,uint8_t G,uint8_t B)                  				                               **                                                              
** 功能描述：跑马灯效果开启函数                                                                        		   **
** 参数说明：R、G、B分别为三个颜色通道的亮度，最大值为255                          					                   **   
** 参数返回：无                                                                                             **
************************************************************************************************************/
void WS2812_Set_Color(uint8_t R,uint8_t Gr,uint8_t B)
{
	color.B=B;
	color.R=R;
	color.Gr=Gr;
	HAL_TIM_PWM_Stop_DMA(&htim2,TIM_CHANNEL_4);  //开启定时器
}


/************************************************************************************************************
** void WS2812_Off(void)                  				                                                         **                                                              
** 功能描述：跑马灯效果关闭函数                                                                        		   **
** 参数说明：无                                                                					                   **   
** 参数返回：无                                                                                             **
************************************************************************************************************/
void WS2812_Off(void)
{
	HAL_TIM_Base_Stop_IT(&htim2);
	for(int i=0;i<LED_NUM;i++)
		{
			WS2812_Set(i,0,0,0);
		}
}
/************************************************************************************************************
** void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)               				                       **                                                              
** 功能描述：tim中断回调函数，控制跑马灯运行与按键消抖                                                   		   **
** 参数说明：无                                                                					                   **   
** 参数返回：无                                                                                             **
************************************************************************************************************/

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	static uint32_t turn=0,Num=0, com_l=0,last_com_l=0,com_r=0,last_com_r=0;
	if(htim==&htim2)
	{
		turn++;
		
	}
	if(turn==80000)
	{
		turn=0;
		com_l=__HAL_TIM_GET_COUNTER(&htim4);//左
		com_r=__HAL_TIM_GET_COUNTER(&htim8);//右
		dif_l=com_l-last_com_l;
		if(dif_l>60000)
		{
			dif_l=65535-dif_l;
		}
		dif_r=com_r-last_com_r;
		if(dif_r>60000)
		{
			dif_r=65535-dif_r;
		}
		last_com_l=com_l;
		last_com_r=com_r;
		for(int i=0;i<LED_NUM;i++)
		{
			WS2812_Set(i,0,0,0);
		}
		if(Num<=3)WS2812_Set(Num%4,color.R/10,color.Gr/10,color.B/10);
		if(Num>=1&&Num<=4)WS2812_Set((Num-1)%4,color.R,color.Gr,color.B);
		if(Num>=2&&Num<=5)WS2812_Set((Num-2)%4,color.R/10,color.Gr/10,color.B/10);
		if(Num<=3)WS2812_Set(7-((Num-0)%4),color.R/10,color.Gr/10,color.B/10);
		if(Num>=1&&Num<=4)WS2812_Set(7-((Num-1)%4),color.R,color.Gr,color.B);
		if(Num>=2&&Num<=5)WS2812_Set(7-((Num-2)%4),color.R/10,color.Gr/10,color.B/10);
		Num++;
		if(Num==8)
		{
			Num=0;
		}	
	}
	if(htim==&htim3)
	{
		if (HAL_GPIO_ReadPin(GPIOB, Key_No_Pin) == GPIO_PIN_RESET)
		{
			Key_val = KEY_RETURN_PRESS;
		}
		if (HAL_GPIO_ReadPin(GPIOB, Key_Yes_Pin) == GPIO_PIN_RESET)
		{
			Key_val = KEY_ENTER_PRESS;
		}
		if (HAL_GPIO_ReadPin(GPIOC, Key_Up_Pin) == GPIO_PIN_RESET)
		{
			Key_val = KEY_UP_PRESS;
		}
		if (HAL_GPIO_ReadPin(GPIOC, Key_Down_Pin) == GPIO_PIN_RESET)
		{
			Key_val = KEY_DOWN_PRESS;
		}
		Display();
		HAL_TIM_Base_Stop_IT(&htim3);
	}
}

